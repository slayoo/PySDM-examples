name: tests+pypi

defaults:
  run:
    shell: bash

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [published]

jobs:
  build:
    strategy:
      matrix:
        platform: [ubuntu-22.04, macos-latest, windows-latest]
        python-version: ["3.7", "3.10"]
      fail-fast: false
    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v2

      - uses: actions/setup-python@v1
        with:
          python-version: ${{ matrix.python-version }}
      - run: |
          python -m pip install --upgrade --user pip
      - run: |
          python -m pip install --user -e .[tests]
      - run: |
          python -We -c "import PySDM_examples"

      # https://github.com/numba/numba/issues/6350#issuecomment-728174860
      - if: startsWith(matrix.platform, 'ubuntu-')
        run: echo NUMBA_THREADING_LAYER=omp >> $GITHUB_ENV

      - if: startsWith(matrix.platform, 'ubuntu-')
        run: |
          # <workaround for apt-get install python3-paraview failing with 404 errors due to "1ubuntu1" vs. "1ubuntu2" in dependency name> 
          wget http://azure.archive.ubuntu.com/ubuntu/pool/universe/i/intel-media-driver/intel-media-va-driver_22.3.1+dfsg1-1ubuntu2_amd64.deb
          sudo apt install ./intel-media-va-driver_22.3.1+dfsg1-1ubuntu2_amd64.deb
          # </workaround>
          sudo apt-get install python3-paraview
      - if: startsWith(matrix.platform, 'macos-')
        run: |
          brew install --cask paraview
          echo `dirname /Applications/ParaView-*.app/Contents/bin/pvpython | head -1` >> $GITHUB_PATH
      - if: matrix.platform != 'windows-latest'
        run: pvpython --version

      - env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: python -m pytest --durations=10 -v -p no:unraisableexception -We
        
